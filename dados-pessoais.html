<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elementos do formulário
    const cepInput = document.querySelector('input[placeholder="Ex. 99999-999"]');
    const estadoNascimentoSelect = document.querySelector('select:contains("Estado de nascimento")');
    const municipioNascimentoSelect = document.querySelector('select:contains("Município de nascimento")');
    const estadoSelect = document.querySelector('select:contains("Estado")');
    const municipioSelect = document.querySelector('select:contains("Município")');
    const estadoEmissorSelect = document.querySelector('select:contains("Estado emissor")');
    
    // Carregar estados brasileiros
    function carregarEstados() {
        const estados = [
            "Acre", "Alagoas", "Amapá", "Amazonas", "Bahia", "Ceará", "Distrito Federal",
            "Espírito Santo", "Goiás", "Maranhão", "Mato Grosso", "Mato Grosso do Sul",
            "Minas Gerais", "Pará", "Paraíba", "Paraná", "Pernambuco", "Piauí", "Rio de Janeiro",
            "Rio Grande do Norte", "Rio Grande do Sul", "Rondônia", "Roraima", "Santa Catarina",
            "São Paulo", "Sergipe", "Tocantins"
        ];

        [estadoNascimentoSelect, estadoSelect, estadoEmissorSelect].forEach(select => {
            select.innerHTML = '<option selected>Selecione...</option>';
            estados.forEach(estado => {
                const option = document.createElement('option');
                option.value = estado;
                option.textContent = estado;
                select.appendChild(option);
            });
        });
    }

    // Buscar CEP via API ViaCEP
    cepInput.addEventListener('blur', function() {
        const cep = this.value.replace(/\D/g, '');
        
        if (cep.length !== 8) {
            return;
        }

        axios.get(`https://viacep.com.br/ws/${cep}/json/`)
            .then(response => {
                const data = response.data;
                if (!data.erro) {
                    // Preencher automaticamente os campos
                    document.querySelector('input[placeholder="Ex. 99999-999"]').value = data.cep;
                    document.querySelector('input[placeholder="Endereço"]').value = data.logradouro;
                    document.querySelector('input[placeholder="Bairro"]').value = data.bairro;
                    
                    // Selecionar estado e município
                    estadoSelect.value = data.uf;
                    municipioSelect.value = data.localidade;
                } else {
                    alert('CEP não encontrado!');
                }
            })
            .catch(error => {
                console.error('Erro ao buscar CEP:', error);
                alert('Erro ao buscar CEP. Tente novamente.');
            });
    });

    // Máscara para CPF
    function aplicarMascaraCPF(input) {
        input.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 11) value = value.substring(0, 11);
            
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            
            e.target.value = value;
        });
    }

    // Máscara para telefone
    function aplicarMascaraTelefone(input) {
        input.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            
            if (value.length <= 10) {
                value = value.replace(/(\d{2})(\d)/, '($1) $2');
                value = value.replace(/(\d{4})(\d)/, '$1-$2');
            } else {
                value = value.replace(/(\d{2})(\d)/, '($1) $2');
                value = value.replace(/(\d{5})(\d)/, '$1-$2');
            }
            
            e.target.value = value;
        });
    }

    // Validação de data de nascimento
    function validarDataNascimento(input) {
        input.addEventListener('change', function(e) {
            const dataNascimento = new Date(e.target.value);
            const hoje = new Date();
            const idade = hoje.getFullYear() - dataNascimento.getFullYear();
            
            if (idade < 14) {
                alert('Candidato deve ter pelo menos 14 anos de idade.');
                e.target.value = '';
            }
        });
    }

    // Carregar municípios baseado no estado (simulação)
    function configurarDependenciaEstadoMunicipio(estadoSelect, municipioSelect) {
        estadoSelect.addEventListener('change', function() {
            const estado = this.value;
            municipioSelect.innerHTML = '<option selected>Selecione...</option>';
            
            if (estado && estado !== 'Selecione...') {
                // Simulação - em produção, buscar da API do IBGE
                const municipiosExemplo = [
                    "Capital", "Interior", "Região Metropolitana"
                ];
                
                municipiosExemplo.forEach(municipio => {
                    const option = document.createElement('option');
                    option.value = municipio;
                    option.textContent = municipio;
                    municipioSelect.appendChild(option);
                });
            }
        });
    }

    // Salvar dados automaticamente
    function configurarAutoSave() {
        const form = document.querySelector('form');
        const inputs = form.querySelectorAll('input, select, textarea');
        
        inputs.forEach(input => {
            input.addEventListener('change', function() {
                salvarDadosTemporarios();
            });
        });
    }

    function salvarDadosTemporarios() {
        const formData = {};
        const form = document.querySelector('form');
        const inputs = form.querySelectorAll('input, select, textarea');
        
        inputs.forEach(input => {
            if (input.name || input.id) {
                const key = input.name || input.id;
                formData[key] = input.value;
            }
        });
        
        localStorage.setItem('dadosPessoaisTemp', JSON.stringify(formData));
    }

    function carregarDadosSalvos() {
        const dadosSalvos = localStorage.getItem('dadosPessoais');
        const dadosTemp = localStorage.getItem('dadosPessoaisTemp');
        const dados = dadosSalvos ? JSON.parse(dadosSalvos) : 
                      dadosTemp ? JSON.parse(dadosTemp) : null;
        
        if (dados) {
            Object.keys(dados).forEach(key => {
                const input = document.querySelector(`[name="${key}"]`) || 
                             document.querySelector(`#${key}`);
                if (input && dados[key]) {
                    input.value = dados[key];
                }
            });
        }
        
        // Carregar dados das etapas anteriores
        const dadosAcesso = localStorage.getItem('dadosAcesso');
        const dadosUnidadeCurso = localStorage.getItem('dadosUnidadeCurso');
        
        if (dadosAcesso) {
            const acesso = JSON.parse(dadosAcesso);
            document.querySelector('input[value="JOAO DA SILVA"]').value = acesso.nome || '';
            document.querySelector('input[value="72303578827"]').value = acesso.cpf || '';
            document.querySelector('input[value="joao@silva.com"]').value = acesso.email || '';
        }
    }

    // Botões de ação
    document.querySelector('.btn-primary-custom').addEventListener('click', function(e) {
        e.preventDefault();
        
        const form = document.querySelector('form');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        // Salvar dados definitivos
        const formData = {};
        const inputs = form.querySelectorAll('input, select, textarea');
        
        inputs.forEach(input => {
            if (input.name || input.id) {
                const key = input.name || input.id;
                formData[key] = input.value;
            }
        });
        
        localStorage.setItem('dadosPessoais', JSON.stringify(formData));
        localStorage.removeItem('dadosPessoaisTemp');
        
        // Redirecionar para próxima etapa
        window.location.href = 'Pont.-acrescida.html';
    });

    document.querySelector('.btn-secondary-custom').addEventListener('click', function() {
        if (confirm('Deseja realmente sair? Seus dados serão salvos para continuar depois.')) {
            salvarDadosTemporarios();
            window.location.href = 'index.html';
        }
    });

    // Inicialização
    carregarEstados();
    aplicarMascaraCPF(document.querySelector('input[value="72303578827"]'));
    aplicarMascaraTelefone(document.querySelector('input[placeholder="Ex. (11) 1234-1234"]'));
    aplicarMascaraTelefone(document.querySelectorAll('input[placeholder="Ex. (11) 1234-1234"]')[1]);
    validarDataNascimento(document.querySelector('input[type="date"]'));
    
    configurarDependenciaEstadoMunicipio(estadoNascimentoSelect, municipioNascimentoSelect);
    configurarDependenciaEstadoMunicipio(estadoSelect, municipioSelect);
    
    configurarAutoSave();
    carregarDadosSalvos();
    
    // Link "Não sei meu CEP"
    document.querySelector('a[href="#"]').addEventListener('click', function(e) {
        e.preventDefault();
        window.open('https://buscacepinter.correios.com.br/app/endereco/index.php', '_blank');
    });
});
</script>
