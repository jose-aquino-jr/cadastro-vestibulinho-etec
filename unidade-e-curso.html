<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const sim = document.getElementById("sim");
    const nao = document.getElementById("nao");
    const bloco = document.getElementById("bloco-curso-detalhado");
    const municipioSelect = document.getElementById("municipio");
    const modalidadeSelect = document.getElementById("modalidade");
    const cursoPeriodoSelect = document.getElementById("curso-periodo");
    const segundaOpcaoSelect = document.getElementById("segunda-opcao");
    const form = document.getElementById("form-inscricao");
    
    // Estados e cidades do Brasil
    const estados = [
        "Acre", "Alagoas", "Amapá", "Amazonas", "Bahia", "Ceará", "Distrito Federal",
        "Espírito Santo", "Goiás", "Maranhão", "Mato Grosso", "Mato Grosso do Sul",
        "Minas Gerais", "Pará", "Paraíba", "Paraná", "Pernambuco", "Piauí", "Rio de Janeiro",
        "Rio Grande do Norte", "Rio Grande do Sul", "Rondônia", "Roraima", "Santa Catarina",
        "São Paulo", "Sergipe", "Tocantins"
    ];

    // Carregar ETECs da API
    async function carregarEtecs() {
        try {
            const response = await axios.get('https://etecs-api.onrender.com/etecs');
            const etecs = response.data;
            
            // Agrupar por município
            const municipios = new Set();
            etecs.forEach(etec => {
                const cidadeMatch = etec.match(/ - ([^-]+)$/);
                if (cidadeMatch) {
                    municipios.add(cidadeMatch[1].trim());
                }
            });
            
            // Ordenar e adicionar ao select
            const municipiosOrdenados = Array.from(municipios).sort();
            municipiosOrdenados.forEach(municipio => {
                const option = document.createElement('option');
                option.value = municipio.toLowerCase().replace(/\s+/g, '-');
                option.textContent = municipio;
                municipioSelect.appendChild(option);
            });
            
        } catch (error) {
            console.error('Erro ao carregar ETECs:', error);
            // Fallback para municípios padrão
            const municipiosPadrao = [
                "São Paulo", "Santo André", "São Bernardo do Campo", "São Caetano do Sul",
                "Guarulhos", "Campinas", "Santos", "Sorocaba", "Ribeirão Preto", "São José dos Campos"
            ];
            
            municipiosPadrao.forEach(municipio => {
                const option = document.createElement('option');
                option.value = municipio.toLowerCase().replace(/\s+/g, '-');
                option.textContent = municipio;
                municipioSelect.appendChild(option);
            });
        }
    }

    // Carregar cursos baseado na modalidade
    function carregarCursos(modalidade) {
        cursoPeriodoSelect.innerHTML = '<option value="" selected disabled>Selecione o curso e o período em que pretende estudar</option>';
        
        const cursos = {
            'ensino-medio': [
                { nome: 'Ensino Médio - Matutino', valor: 'em-manha' },
                { nome: 'Ensino Médio - Vespertino', valor: 'em-tarde' },
                { nome: 'Ensino Médio - Noturno', valor: 'em-noite' }
            ],
            'ensino-medio-integrado': [
                { nome: 'Administração - Integral', valor: 'adm-integrado' },
                { nome: 'Informática - Integral', valor: 'info-integrado' },
                { nome: 'Enfermagem - Integral', valor: 'enfermagem-integrado' },
                { nome: 'Marketing - Integral', valor: 'marketing-integrado' }
            ],
            'ensino-medio-eja': [
                { nome: 'Ensino Médio - EJA Noturno', valor: 'eja-noite' }
            ],
            'tecnico-integrado': [
                { nome: 'Administração - Integral', valor: 'adm-integrado' },
                { nome: 'Informática - Integral', valor: 'info-integrado' },
                { nome: 'Enfermagem - Integral', valor: 'enfermagem-integrado' }
            ],
            'tecnico-subsequente': [
                { nome: 'Administração - Matutino', valor: 'adm-manha' },
                { nome: 'Administração - Vespertino', valor: 'adm-tarde' },
                { nome: 'Administração - Noturno', valor: 'adm-noite' },
                { nome: 'Informática - Matutino', valor: 'info-manha' },
                { nome: 'Informática - Vespertino', valor: 'info-tarde' },
                { nome: 'Informática - Noturno', valor: 'info-noite' },
                { nome: 'Enfermagem - Matutino', valor: 'enfermagem-manha' },
                { nome: 'Enfermagem - Vespertino', valor: 'enfermagem-tarde' },
                { nome: 'Enfermagem - Noturno', valor: 'enfermagem-noite' }
            ],
            'tecnico-concomitante': [
                { nome: 'Administração - Noturno', valor: 'adm-concomitante' },
                { nome: 'Informática - Noturno', valor: 'info-concomitante' }
            ]
        };

        const cursosSelecionados = cursos[modalidade] || [];
        
        cursosSelecionados.forEach(curso => {
            const option = document.createElement('option');
            option.value = curso.valor;
            option.textContent = curso.nome;
            cursoPeriodoSelect.appendChild(option);
        });
        
        // Atualizar segunda opção também
        carregarSegundaOpcao(modalidade);
    }

    function carregarSegundaOpcao(modalidade) {
        segundaOpcaoSelect.innerHTML = '<option value="" selected disabled>Selecione o curso</option>';
        
        const optionNenhuma = document.createElement('option');
        optionNenhuma.value = "nenhuma";
        optionNenhuma.textContent = "Nenhuma segunda opção";
        segundaOpcaoSelect.appendChild(optionNenhuma);
        
        // Mesma lógica dos cursos principais
        const cursos = {
            'ensino-medio': [
                { nome: 'Ensino Médio - Matutino', valor: 'em-manha-2' },
                { nome: 'Ensino Médio - Vespertino', valor: 'em-tarde-2' }
            ],
            'tecnico-subsequente': [
                { nome: 'Administração - Matutino', valor: 'adm-manha-2' },
                { nome: 'Informática - Vespertino', valor: 'info-tarde-2' },
                { nome: 'Enfermagem - Noturno', valor: 'enfermagem-noite-2' }
            ]
        };

        const cursosSelecionados = cursos[modalidade] || [];
        
        cursosSelecionados.forEach(curso => {
            const option = document.createElement('option');
            option.value = curso.valor;
            option.textContent = curso.nome;
            segundaOpcaoSelect.appendChild(option);
        });
    }

    function atualizarVisibilidade() {
        if (sim.checked) {
            bloco.style.display = "none"; 
        } else {
            bloco.style.display = "block";
        }
    }

    // Event Listeners
    sim.addEventListener("change", atualizarVisibilidade);
    nao.addEventListener("change", atualizarVisibilidade);
    
    modalidadeSelect.addEventListener("change", function() {
        carregarCursos(this.value);
    });

    // Botões de ação
    document.querySelector('.btn-primary-custom').addEventListener('click', function(e) {
        e.preventDefault();
        
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        // Salvar dados no localStorage
        const dadosUnidadeCurso = {
            treineiro: document.querySelector('input[name="treineiro"]:checked').value,
            municipio: municipioSelect.value,
            modalidade: modalidadeSelect.value,
            curso: cursoPeriodoSelect.value,
            segundaOpcao: segundaOpcaoSelect.value,
            prerequisito: document.querySelector('input[name="prerequisito"]:checked').value
        };
        
        localStorage.setItem('dadosUnidadeCurso', JSON.stringify(dadosUnidadeCurso));
        
        // Redirecionar
        window.location.href = 'dados-pessoais.html';
    });

    document.querySelector('.btn-secondary-custom').addEventListener('click', function() {
        if (confirm('Deseja realmente sair? Seus dados serão salvos para continuar depois.')) {
            // Salvar dados temporários
            const dadosTemp = {
                treineiro: document.querySelector('input[name="treineiro"]:checked').value,
                municipio: municipioSelect.value,
                modalidade: modalidadeSelect.value,
                curso: cursoPeriodoSelect.value
            };
            localStorage.setItem('dadosTempUnidadeCurso', JSON.stringify(dadosTemp));
            window.location.href = 'index.html';
        }
    });

    // Inicialização
    carregarEtecs();
    atualizarVisibilidade();
    
    // Carregar dados salvos se existirem
    const dadosSalvos = localStorage.getItem('dadosUnidadeCurso');
    if (dadosSalvos) {
        const dados = JSON.parse(dadosSalvos);
        if (dados.treineiro === 'Sim') sim.checked = true;
        else nao.checked = true;
        
        municipioSelect.value = dados.municipio || '';
        modalidadeSelect.value = dados.modalidade || '';
        
        if (dados.modalidade) {
            carregarCursos(dados.modalidade);
            setTimeout(() => {
                cursoPeriodoSelect.value = dados.curso || '';
                segundaOpcaoSelect.value = dados.segundaOpcao || '';
            }, 100);
        }
        
        if (dados.prerequisito) {
            document.querySelector(`input[name="prerequisito"][value="${dados.prerequisito}"]`).checked = true;
        }
    }
});
</script>
